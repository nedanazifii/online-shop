{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<br>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      {% if cart_products %}
        {% for product in cart_products %}
          <div class="card product-card mb-5">
            <div class="row g-0">
              <div class="col-md-3">
                <img src="{{ product.picture.url }}" class="img-fluid rounded-start" alt="...">
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <h4 class="card-title">{{ product.name }}</h4><br>
                  <h6>توضیحات محصول: </h6>
                  <p class="card-text">{{ product.description }}</p>

                  {% if product.is_sale %}
                  <p class="card-text">
                    قیمت: <strike>{{ product.price|intcomma }}</strike><br>
                    {{ product.sale_price|intcomma }}
                  </p>
                  {% else %}
                  <p class="card-text">قیمت: {{ product.price|intcomma }}</p>
                  {% endif %}
                  <br>

                  <p class="card-text d-flex align-items-center" style="gap: 8px;">
                    <span>تعداد:</span>
                    <input
                      type="number"
                      class="form-control"
                      style="width: 80px;"
                      id="select{{ product.id }}"
                      min="1"
                      max="10"
                      value="{% for key, value in quantities.items %}
                               {% if key == product.id|slugify %}
                                 {{ value }}
                               {% endif %}
                             {% endfor %}">
                  </p>
                  
                  <button type="button" data-index={{ product.id }} class="btn btn-primary update-cart">ویرایش</button>
                  <button type="button" data-index={{ product.id }} class="btn btn-danger delete-product">حذف</button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}

        {% else %}
        <div class="text-center my-5" style="font-size: 1.3rem; color: #555;">
          <img src="{% static 'assets/empty-card.png '%}" alt="empty-card" style="width:200px; height: 180px;">
          <h4>سبد خرید شما خالی است.</h4>
          <h6>لطفاً محصولات مورد نظرتان را به سبد خرید اضافه کنید.</h6>
        </div>
      {% endif %}

      <div class="text-center">
        <a href="{% url 'home' %}" class="back-btn">بازگشت به فروشگاه</a>
      </div>
    </div>
    
    {% if cart_products %}
        <div class="col-md-4">
          <div class="payment-box">
            <h5 class="payment-title">
              <i class="bi bi-credit-card"></i> اطلاعات پرداخت
            </h5>
        
            <div class="payment-row">
              <span class="label">مبلغ قابل پرداخت:</span>
              <span class="amount">{{ total|intcomma }} <span class="unit">تومان</span></span>
            </div>
        
            <button class="btn payment-btn">ادامه به پرداخت</button>
          </div>
        </div>
    {% endif %}
    
    

  </div>
</div>

<br><br><br><br><br>

<script>
  $(document).on('click', '.update-cart', function(e) {
    e.preventDefault();
    var productid = $(this).data('index');
    $.ajax({
      type: 'POST',
      url: "{% url 'cart_update' %}",
      data: {
        product_id: productid,
        product_qty: $('#select' + productid).val(),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json) {
        location.reload();
      },
      error: function(xhr, errmsg, err) {}
    });
  });

  $(document).on('click', '.delete-product', function(e) {
    e.preventDefault();
    $.ajax({
      type: 'POST',
      url: "{% url 'cart_delete' %}",
      data: {
        product_id: $(this).data('index'),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json) {
        location.reload();
      },
      error: function(xhr, errmsg, err) {}
    });
  });
</script>
{% endblock %}
