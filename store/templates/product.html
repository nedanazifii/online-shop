{% extends 'base.html' %}
{% load humanize %}

{% block content %}

    <div class="container py-5">
      <div class="row product-card">
        <div class="col-md-5 p-3">
          <img src="{{ product.picture.url }}" class="product-image" alt="{{ product.name }}">
        </div>
        <div class="col-md-7 p-4">
          <h1 class="product-title mb-3">{{ product.name }}</h1>
          <p class="text-muted mb-4">{{ product.description|linebreaks}}</p>

          <h5 class="mb-2">ویژگی‌ها:</h5>

          <!-- {% regroup product.feature_values.all by subfeature.feature as feature_groups %}

          <ul>
            {% for group in feature_groups %}
              <li>
                <strong>{{ group.list.0.subfeature.feature.title }}</strong>:
                <ul>
                  {% for item in group.list %}
                    <li>{{ item.subfeature.title }}{% if item.value %}: {{ item.value }}{% endif %}</li>
                  {% endfor %}
                </ul>
              </li>
            {% empty %}
              <li>هیچ ویژگی‌ای برای این محصول ثبت نشده.</li>
            {% endfor %}
          </ul>
           -->
          

          <div class="mb-4">
            {% if product.is_sale %}
              <span class="price-old">{{ product.price|intcomma }} تومان</span>
              <span class="price-new">{{ product.sale_price|intcomma }} تومان</span>
            {% else %}
              <span class="price-new">{{ product.price|intcomma }} تومان</span>
            {% endif %}
          </div>

          <div class="mb-4">
            <label for="cart-qty" class="form-label">تعداد</label>
            <select class="form-select w-25 d-inline" id="cart-qty">
              <option selected disabled>انتخاب کنید</option>
              {% for i in "1234" %}
                <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-buy px-4" type="button" value="{{ product.id }}" id="add-cart">
              افزودن به سبد خرید
            </button>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">بازگشت به صفحه اصلی</a>
          </div>
        </div>
      </div>
    </div>

    <div id="add-to-cart-popup" class="popup" style="display: none;">
      <div class="popup-content">
        <span class="close-popup">&times;</span>
        <h5>کالا به سبد خرید اضافه شد</h5>
        <div class="popup-body d-flex align-items-center gap-3 my-3">
          <img id="popup-image" src="{{ product.picture.url }}" alt="product" style="width: 60px; height: auto; border-radius: 8px;" />
          <div>
            <p id="popup-name" class="mb-1">{{ product.name }}</p>
            <p id="popup-price" class="text-muted small mb-0">
              {% if product.is_sale %}
                {{ product.sale_price|intcomma }} تومان
              {% else %}
                {{ product.price|intcomma }} تومان
              {% endif %}
            </p>
          </div>
        </div>
        <a href="{% url 'cart_summery' %}" class="btn btn-primary btn-sm w-100">مشاهده سبد خرید</a>
      </div>
    </div>


    <script>
      $(document).on('click', '#add-cart', function(e){
        e.preventDefault();
        $.ajax({
          type: 'POST',
          url: '{% url "cart_add" %}',
          data:{
            product_id: $('#add-cart').val(),
            product_qty : $('#cart-qty option:selected').text(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action : 'post'
          },
          success: function(json){
            document.getElementById('cart_quantity').textContent = json.qty;
            $('#add-to-cart-popup').fadeIn();
          },
          error: function(xhr, errmsg, err){
            
          }
        });
      });
    
      $(document).on('click', '.close-popup', function () {
        $('#add-to-cart-popup').fadeOut();
      });
    </script>
    
{% endblock %}
